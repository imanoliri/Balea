<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procedure Fill-Out Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f8f8f8;
      border-radius: 8px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
    }
    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
    }
    button {
      padding: 10px 20px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #005f99;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      margin-bottom: 10px;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <h1>Procedure Fill-Out Tool</h1>

  <label for="procedureId">Enter Procedure ID or Name:</label>
  <select id="procedureId"></select>
  <button onclick="loadProcedure()">Load Procedure</button>

  <div id="procedureForm" style="display:none;">
    <h2 id="procedureTitle"></h2>
    <p><strong>ID:</strong> <span id="procedureID"></span></p>
    <p><strong>Purpose:</strong> <span id="procedurePurpose"></span></p>

    <h3>Steps</h3>
    <ul id="stepsList"></ul>

    <div id="dynamicFields"></div>

    <button onclick="submitFile()">Send to Balea Drive</button>
    <button onclick="saveProcedureResult()">Save Procedure Record</button>
  </div>

  <script>
    let id = null;
    let procedureFile = null;
    let currentProcedure = null;
    let stepChecks = [];
    let dynamicFieldInputs = {};

  
    async function listJSONFiles() {
      try {
        const response = await fetch(".");
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");

        const links = Array.from(doc.querySelectorAll("a"));
        const jsonFiles = links
          .map(link => link.getAttribute("href"))
          .filter(href => href && href.endsWith(".json"));

        const dropdown = document.getElementById("procedureId");
        jsonFiles.forEach(file => {
          const option = document.createElement("option");
          option.value = file;
          option.textContent = file;
          dropdown.appendChild(option);
        });
      } catch (err) {
        console.error("Could not load file list:", err);
      }
    }

    listJSONFiles();

    function loadProcedure() {
      id = document.getElementById('procedureId').value;
      procedureFile = id //`${id}.json` //`./business/operations/${id}.json`

      fetch(procedureFile)
        .then(response => response.json())
        .then(data => {
          currentProcedure = data;
          stepChecks = new Array(data.steps?.length || 0).fill(false);
          document.getElementById('procedureForm').style.display = 'block';
          document.getElementById('procedureTitle').textContent = data.title;
          document.getElementById('procedureID').textContent = data.procedure_id;
          document.getElementById('procedurePurpose').textContent = data.purpose;

          const stepsList = document.getElementById('stepsList');
          stepsList.innerHTML = '';
          (data.steps || []).forEach((step, index) => {
            const li = document.createElement('li');
            li.className = 'step-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.onchange = () => stepChecks[index] = checkbox.checked;

            const label = document.createElement('label');
            label.textContent = step;

            li.appendChild(checkbox);
            li.appendChild(label);
            stepsList.appendChild(li);
          });

          // Populate dynamic fields
          const dynamicFieldsDiv = document.getElementById('dynamicFields');
          dynamicFieldsDiv.innerHTML = '';
          dynamicFieldInputs = {};
          for (const key in data) {
            if (data[key] === '' || (Array.isArray(data[key]) && data[key].length === 0)) {
              const label = document.createElement('label');
              label.textContent = key.replaceAll('_', ' ');
              const input = document.createElement('input');
              input.type = key.includes('date') ? 'date' : 'text';
              input.oninput = (e) => dynamicFieldInputs[key] = e.target.value;
              dynamicFieldsDiv.appendChild(label);
              dynamicFieldsDiv.appendChild(document.createElement('br'));
              dynamicFieldsDiv.appendChild(input);
              dynamicFieldsDiv.appendChild(document.createElement('br'));
              dynamicFieldsDiv.appendChild(document.createElement('br'));
            }
          }
        })
        .catch(() => alert(`Procedure not found:\n${procedureFile}`));
    }

    function saveProcedureResult() {
      if (!currentProcedure) return;

      const result = {
        ...dynamicFieldInputs,
        procedure_id: currentProcedure.procedure_id,
        step_checklist: stepChecks,
        status: "Completed"
      };

      const blob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const timestamp = Date.now();
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentProcedure.procedure_id}_${timestamp}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby0zeXyi9-sdk_ZOnaoZRmFueYsdD5Nb2imqLHYKHZBV6ktKY1sHAiTqvqkCRCjU-Ytcw/exec";

    async function submitFile() {
        if (!currentProcedure) return;

        const result = {
          filename: `${currentProcedure.procedure_id}_${Date.now()}.json`,
          content: JSON.stringify({
            ...dynamicFieldInputs,
            procedure_id: currentProcedure.procedure_id,
            step_checklist: stepChecks,
            status: "Completed"
          })
        };

        const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `data=${encodeURIComponent(JSON.stringify(result))}`
        });

        const resText = await response.text();
        alert(resText);
      }

  </script>
</body>
</html>
